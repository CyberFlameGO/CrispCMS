{# 
 # Copyright 2020 Pixelcat Productions <support@pixelcatproductions.net>
 # @author 2020 Justin Ren√© Back <jback@pixelcatproductions.net>
 #
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 #      http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
#}


{#
Die Variablen unten sind sehr wichtig bitte bei jeder Datei setzen!
    - JB
#}
{% set currentPage = 'txt' %}
{% set pageTitle = 'views.txt.title'|translate %}
{% set error = false %}


{% extends "base.twig" %}

{% block content %}
    <!-- 20x000032 -->
    {{ include("components/navbar.twig") }}

    <div class="jumbotron" id="api">
        <div><h1>{{ 'views.txt.title'|translate }}</h1></div>
        <p>
            {{ 'views.txt.jumbotron.text'|translate|raw }}
        </p>
    </div>


    <div class="container mb-4">


        <form>
            <div class="form-group">
                <label for="domain">{{ 'views.txt.form.service_domain.label'|translate }}:</label>
                <input type="text" class="form-control" placeholder="{{ 'views.txt.form.service_domain.placeholder'|translate }}" id="service_domain">
                <div class="valid-feedback">
                    {{ 'views.txt.form.service_domain.valid_feedback'|translate }}
                </div>
                <div class="invalid-feedback" id="error">
                    {{ 'views.txt.form.service_domain.invalid_feedback'|translate }}
                </div>
                <label for="service_domain" class="text-muted">{{ 'views.txt.form.service_domain.label_muted'|translate }}</label>
            </div>
            <div class="card" id="resultcard" style="display: none;">
                <div class="card-header">
                    {{ 'views.txt.card.results.header'|translate }}
                </div>
                <div class="card-body">
                    <pre id="result">

                    </pre>
                </div>
            </div>
            <hr>

            <button type="submit" id="submit" class="btn btn-primary" disabled>Validate</button>
        </form> 
    </div> <!-- /container -->
{% endblock %}
{% block scripts %}
    <script>
        let domainIterator = 0;
        $(document).ready(function () {

            $("form").on('submit', function (e) {
                $("#service_domain").removeClass("is-invalid");
                $("#service_domain").removeClass("is-valid");
                $("#resultcard").hide();
                e.preventDefault();
                $.post("", {domain: $("#service_domain").val()}, function (result) {
                    if (result.error & 0x10) {
                        $("#error").html(result.message);
                        $("#service_domain").addClass("is-invalid");
                    }
                    if (result.error & 0x100) {
                        $("#result").html(result.message);
                        $("#resultcard").show();
                    }
                });

            });

            $(document).on('keyup', '#service_domain', function () {
                $(this).removeClass("is-valid");
                $("#error").html('{{ 'views.txt.form.service_domain.invalid_feedback'|translate }}');
                $("#submit").prop('disabled', true);
                if ($(this).val() === "") {
                    return $(this).addClass("is-invalid");
                }
                if (new RegExp(/^.*?:\/\//).test($(this).val())) {
                    return $(this).addClass("is-invalid");
                }
                if (!new RegExp(/^(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]$/).test($(this).val())) {
                    return $(this).addClass("is-invalid");
                }
                if ($(this).val().startsWith("www.")) {
                    return $(this).addClass("is-invalid");
                }

                $(this).removeClass("is-invalid");
                $(this).addClass("is-valid");
                $("#submit").prop('disabled', false);
            });
        });
    </script>
{% endblock %}