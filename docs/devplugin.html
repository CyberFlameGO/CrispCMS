<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CrispCMS Plugin API: Developing Plugins</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="tosdr-icon-180.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CrispCMS Plugin API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('devplugin.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Developing Plugins </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#intro">Directory Structure</a></li>
<li class="level1"><a href="#metadata">plugin.json - In detail</a><ul><li class="level2"><a href="#pluginname">name - The name of your plugin</a></li>
<li class="level2"><a href="#plugindesc">description - The description of your plugin</a></li>
<li class="level2"><a href="#pluginhook">hookFile - The name of your hook file</a></li>
<li class="level2"><a href="#pluginauthor">author - Your name, for credits</a></li>
<li class="level2"><a href="#plugininstall">onInstall - Configure your plugin on installation</a><ul><li class="level3"><a href="#plugininstalltranslation">createTranslationKeys - Creates translations when installing the plugin</a></li>
<li class="level3"><a href="#plugininstallstorage">createKVStorageItems - Creates config keys when installing the plugin</a></li>
<li class="level3"><a href="#plugininstalldep">activateDependencies - Activate other plugins when installing the plugin</a></li>
</ul>
</li>
<li class="level2"><a href="#pluginuninstall">onUninstall - Configuration for plugin removal</a><ul><li class="level3"><a href="#pluginuninstalldata">deleteData - Boolean to delete data on removal</a></li>
<li class="level3"><a href="#pluginuninstalldep">deactivateDependencies - Deactivate other plugins when uninstalling the plugin</a></li>
<li class="level3"><a href="#pluginuninstallpurge">purgeDependencies - Deactivate other plugins when uninstalling the plugin</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#hookFileinfo">The hook File</a></li>
<li class="level1"><a href="#createAPI">Creating API interface</a></li>
<li class="level1"><a href="#crons">Creating and using crons</a><ul><li class="level2"><a href="#createcron">Creating Crons</a></li>
</ul>
</li>
<li class="level1"><a href="#navbar">Adding Items to Navigation Bar</a></li>
</ul>
</div>
<div class="textblock"><p>Plugin documentation for Crisp</p>
<h1><a class="anchor" id="intro"></a>
Directory Structure</h1>
<pre class="fragment">.
└── plugins/
    └── your_plugin_folder/ - This is your plugin folder name, all lowercase, no spaces
        ├── includes/ - Here lies the PHP code for templates
        │   ├── api/ - Files in here will be executed when calling their api interface =&gt; export.php =&gt; /api/export/
        │   └── views/ - Files in here will be executed when visiting their page. welcome.php =&gt; /en/welcome
        │   └── cron.php - This file will be executed when a cron is called
        ├── templates/ - This is the template directory to store the twig tpls in
        │   └── views/ - Files in here will be rendered when visiting their page. welcome.twig =&gt; /en/welcome
        ├── hook.php - The hook file gets called regardless which page is opened
        └── plugin.json - Metadata, the heart of your plugin
</pre><p>It is important that each twig template, needs their respective PHP code.</p>
<p>If you want to create a page which can be called at /en/welcome the directory structure has to look like this:</p>
<pre class="fragment">.
└── plugins/
    └── your_plugin_folder/
        ├── includes/
        │   ├── api/
        │   └── views/
        │       └── welcome.php - CREATE THIS FILE
        ├── templates/
        │   └── views/
        │       └── welcome.twig - CREATE THIS FILE
        ├── hook.php
        └── plugin.json
</pre><h1><a class="anchor" id="metadata"></a>
plugin.json - In detail</h1>
<p>The plugin.json file is the heart of your plugin. It can create config keys, translations, languages, uninstall plugins, install plugins and more for you automatically.</p>
<p>Example plugin.json </p><pre class="fragment">{
    "name": "Hello World Plugin",
    "description": "Tutorial plugin plugin for CrispCMS",
    "hookFile": "hook.php",
    "author": "Justin René Back &lt;jback@pixelcatproductions.net&gt;",
    "onInstall": {
        "createTranslationKeys": {
            "en": {
                "hello_world": "Hello World"
            },
            "de": {
                "hello_world": "Hallo Welt"
            }
        },
        "createKVStorageItems": {
            "display_hello_world": true
        },
        "activateDependencies": []
    },
    "onUninstall": {
        "deleteData": true,
        "deactivateDependencies": [],
        "purgeDependencies": []
    }
}
</pre><h2><a class="anchor" id="pluginname"></a>
name - The name of your plugin</h2>
<p>This property contains the full name of your plugin, you can use all characters you want. This will be shown when installing a plugin</p>
<h2><a class="anchor" id="plugindesc"></a>
description - The description of your plugin</h2>
<p>This property defines a description which is shown when listing your plugin. Keep it short</p>
<h2><a class="anchor" id="pluginhook"></a>
hookFile - The name of your hook file</h2>
<p>A hook file executes code on every page. More about this property is defined below.</p>
<h2><a class="anchor" id="pluginauthor"></a>
author - Your name, for credits</h2>
<p>Simply your name</p>
<h2><a class="anchor" id="plugininstall"></a>
onInstall - Configure your plugin on installation</h2>
<p>onInstall offers a variety of options which get executed when installing the plugin.</p>
<p>All data specified in onInstall is automatically purged upon removal of the plugin, if deleteData is set to true</p>
<h3><a class="anchor" id="plugininstalltranslation"></a>
createTranslationKeys - Creates translations when installing the plugin</h3>
<p>Translations are created using multi-dimensional arrays/keys</p>
<p>The structure is as follows:</p>
<pre class="fragment">{
    "en": {
        "hello_world": "Hello World"
    },
    "de": {
        "hello_world": "Hallo Welt"
    }
}
</pre><p>You can use any language key, even if it does not exist, it will be created when installing the plugin.</p>
<h3><a class="anchor" id="plugininstallstorage"></a>
createKVStorageItems - Creates config keys when installing the plugin</h3>
<p>Configuration keys are dynamic key/value entries in the database. They can be created via PHP or via the onInstall trigger. However we recommend creating them via the Trigger, as all KV entries specified here, will be purged upon removal of a plugin, cleaning up leftovers. Manual created keys, will not be removed.</p>
<p>The structure is as follows:</p>
<pre class="fragment">{
    "display_hello_world": true
}
</pre><p>The following data types are supported:</p>
<ul>
<li>string</li>
<li>integer</li>
<li>array (Will be serialized and unserialized)</li>
<li>double</li>
<li>NULL</li>
<li>serialized</li>
<li>boolean</li>
</ul>
<h3><a class="anchor" id="plugininstalldep"></a>
activateDependencies - Activate other plugins when installing the plugin</h3>
<p>This contains a list of plugin folders to load when installing the plugin.</p>
<p>Example: </p><pre class="fragment">["plugin1","plugin2"]
</pre><h2><a class="anchor" id="pluginuninstall"></a>
onUninstall - Configuration for plugin removal</h2>
<p>This does the same as onInstall, except for when the plugin has been uninstalled and with different options</p>
<h3><a class="anchor" id="pluginuninstalldata"></a>
deleteData - Boolean to delete data on removal</h3>
<p>This bool overrides if plugin data should be purged when uninstalling.</p>
<h3><a class="anchor" id="pluginuninstalldep"></a>
deactivateDependencies - Deactivate other plugins when uninstalling the plugin</h3>
<p>This contains a list of plugin folders to remove when uninstalling the plugin. Respecting their deleteData property</p>
<dl class="section warning"><dt>Warning</dt><dd>When using purgeDependencies, leave this list empty as it will lead to conflicts!</dd></dl>
<p>Example: </p><pre class="fragment">["plugin1","plugin2"]
</pre><h3><a class="anchor" id="pluginuninstallpurge"></a>
purgeDependencies - Deactivate other plugins when uninstalling the plugin</h3>
<p>This contains a list of plugin folders to purge when uninstalling the plugin. This property will override deleteData to true and will delete all data of the specified plugins</p>
<dl class="section warning"><dt>Warning</dt><dd>When using deactivateDependencies, leave this list empty as it will lead to conflicts!</dd></dl>
<p>Example: </p><pre class="fragment">["plugin1","plugin2"]
</pre><h1><a class="anchor" id="hookFileinfo"></a>
The hook File</h1>
<p>The hook file gets called everytime a page has been rendered, called or executed.</p>
<p>It has to be defined in the plugin.json with the hookFile property. Without this file, your plugin cannot be installed.</p>
<p>the hook file has the following context which can be access in the file itself</p>
<pre class="fragment">crisp\core\Plugin $this
</pre><h1><a class="anchor" id="createAPI"></a>
Creating API interface</h1>
<p>Crisp offers a feature to hook into the API available at /api/&lt;interface&gt;/&lt;query&gt;</p>
<p>To create a new interface, create a new file in the includes/api/ folder.</p>
<p>To make the API available at /api/exportdata/user</p>
<p>You have to create the file includes/api/exportdata.php</p>
<p>Within this file, you can access the &lt;query&gt;=user with the $_QUERY variable</p>
<p>The file you created, does not have any object context. You need to initialize new classes or use static ones.</p>
<p>Variables: </p><pre class="fragment">$_QUERY - This variable holds the string after the interface /api/&lt;interface&gt;/&lt;query&gt;
</pre><h1><a class="anchor" id="crons"></a>
Creating and using crons</h1>
<p>Crons are an easy way to execute tasks periodically, such as cleaning up cache files, purging sessions and so on.</p>
<p>Crons are executed in the includes/cron.php file.</p>
<p>\info It is not required to exist, meaning, you plugin will install fine without it. However if you intend to use the cron system, its required.</p>
<p>Variables in the Cron File: </p><pre class="fragment">$_CRON =&gt; array(14) {
  ["ID"]=&gt;
  string(5) "11701"
  ["Type"]=&gt;
  string(19) "execute_plugin_cron"
  ["ScheduledAt"]=&gt;
  string(19) "0000-00-00 00:00:00"
  ["CreatedAt"]=&gt;
  string(19) "0000-00-00 00:00:00"
  ["FinishedAt"]=&gt;
  string(19) "0000-00-00 00:00:00"
  ["UpdatedAt"]=&gt;
  string(19) "0000-00-00 00:00:00"
  ["StartedAt"]=&gt;
  string(19) "0000-00-00 00:00:00"
  ["Finished"]=&gt;
  string(1) "0"
  ["Started"]=&gt;
  string(1) "0"
  ["Canceled"]=&gt;
  string(1) "0"
  ["Failed"]=&gt;
  string(1) "0"
  ["Data"]=&gt;
  object(stdClass)#54 (2) {
    ["plugin"]=&gt;
    string(8) "cronjobs"
    ["data"]=&gt;
    string(10) "I am data!"
    ["name"]=&gt;
    string(10) "event_type"
  }
  ["Log"]=&gt;
  NULL
  ["Interval"]=&gt;
  string(8) "5 SECOND"
}
</pre><p>$_CRON["Data"]["name"] contains the $Type you have provided to identify your crons. Example code:</p>
<pre class="fragment">&lt;?php
switch($_CRON["Data"]["name"]){
    case "purge_cache":
        echo "I am going to purge the cache!". PHP_EOL;
        \crisp\api\lists\Cron::create("execute_plugin_cron", json_encode(array("plugin" =&gt; $_CRON["Data"]["plugin"], "data" =&gt; "I am data", "name" =&gt; "purge_cache")), $_CRON["Interval"]);
        break;
    default:
        echo "Invalid type :(";
}
</pre><dl class="section warning"><dt>Warning</dt><dd>CRONs do NOT run in an environment, meaning Config::get will not work like the way it does in the plugin files. To get the config "helloworld" in the plugin you would have to run Config::get("plugin_PLUGINNAME_helloworld") in the cron file.</dd>
<dd>
It is important to mark the status of a CRON. If it fails to execute, run \crisp\api\lists\Cron::markAsFailed($_CRON["ID"]); if the execution was successful run \crisp\api\lists\Cron::markAsFinished($_CRON["ID"]); If you don't do this, the cron will stuck at "Running" forever.</dd></dl>
<h2><a class="anchor" id="createcron"></a>
Creating Crons</h2>
<p>Creating crons is easy. As per the example above, it is important to repeat the cron creation though, else crons are not executed again. It's rather a scheduler than real UNIX crons.</p>
<p>You can create crons using the object context in code-template files or using the static \crisp\api\lists\Crons::createCron method, there are differences though! See below.</p>
<p>Creating crons when an object context is present:</p>
<pre class="fragment">&lt;?php

$this-&gt;createCron("purge_cache", "I am data!", "5 SECOND");
</pre><p>Creating crons from static methods</p>
<pre class="fragment">&lt;?php

\crisp\api\lists\Cron::create("execute_plugin_cron", json_encode(array("plugin" =&gt; $_CRON["Data"]["plugin"], "data" =&gt; "I am data", "name" =&gt; "purge_cache")), $_CRON["Interval"]);
</pre><p>The difference between static methods is, you have to define the plugin name yourself and use a different trigger.</p>
<h1><a class="anchor" id="navbar"></a>
Adding Items to Navigation Bar</h1>
<p>With a recent update, it's now possible to add navigation items programmatically.</p>
<p>This feature makes a good use of the hook file as it ensures its executed everywhere.</p>
<p>Using the function: </p><pre class="fragment">\crisp\core\Template::addtoNavbar("LINK_ID", "Link text, "/link_url", "_self", -97);
</pre><p> You can add links to all navbars which support this feature by using the navbar global</p>
<pre class="fragment">{% for item in GLOBALS.navbar %}
    &lt;li class="nav-item {% if currentPage == item.ID %} active{% endif %}"&gt;
        &lt;a target="{{ item.target }}" class="nav-link {% if currentPage == item.ID %} active{% endif %}" href="{{ item.href }}"&gt;{{ item.html }}&lt;/a&gt;
    &lt;/li&gt;
{% endfor %}
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
